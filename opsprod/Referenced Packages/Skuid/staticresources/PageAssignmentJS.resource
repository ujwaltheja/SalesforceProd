"use strict";!function(a){var b=a.$,c=a.$M,d=a.$L,e=a.snippet,f=e.registerSnippet,g=a.utils,h=a.ui,i=h.getFieldRenderer;f("Multipicklist",function(){i("MULTIPICKLIST").edit(arguments[0],g.decodeHTML(arguments[1]))}),f("skuid.snippets.utils.GetSObjectsAsItems",function(){var a=[],c=g.sObjectList;return c&&b.each(c,function(b,c){a.push({value:c,label:c})}),a}),f("skuid.pageAssignments.assignedTo",function(e,f){var h,i,j=c("Profiles"),k=e._GUID,l=e.id,m=e.model,n=e.row,o=m.getField("skuid__Assigned_To_User__c"),p=m.getFieldValue(n,"skuid__Assigned_To_User__c",!0);if(f?g.startsWith(f,j.keyPrefix)?(h="profile",i=j.accessible&&j.dataMap[f]&&j.dataMap[f].Name):p&&(h="user",i=m.getFieldValue(n,"skuid__Assigned_To_User__r.Name")):(i=d("Organization_Default"),h="org"),"edit"===e.mode&&j.accessible&&o.editable){var q=b("<select>");q.append(b("<option>").prop("selected","org"===h).attr("value","org").text(d("Organization_Default"))),q.append(b("<option>").prop("selected","profile"===h).attr("value","profile").text(d("Profile_Object_Label"))),q.append(b("<option>").prop("selected","user"===h).attr("value","user").text(o.referenceTo[0].label)),q.on("change",function(){var a=q.val(),b={};b[l]="",b.skuid__Assigned_To_User__c="",h=a,m.updateRow(n,b,{initiatorId:k}),"org"!==a&&a?"profile"===a?(s.show().val(""),u.hide()):"user"===a&&(s.hide(),u.show()):(s.hide(),u.hide())});var r=[];b.each(j.data,function(){var a={label:this.Name,value:this.Id};r.push(a)});var s=b("<input>").val(i).autocomplete({source:r,select:function(a,b){return m.updateRow(n,l,b.item.value,{initiatorId:k}),s.val(b.item.label),!1},minLength:0}).blur(function(){""===s.val()&&m.updateRow(n,l,"",{initiatorId:k})}),t=new a.ui.Field(n,m,null,{fieldId:"skuid__Assigned_To_User__c",useSOSL:!0,SOSLFields:"ALL FIELDS",searchFields:[{id:"Name"}],returnFields:[{id:"Name",showInSearchDialog:!0},{id:"Title",showInSearchDialog:!0},{id:"Profile.Name",label:"<label>"+j.label+"</label>",showInSearchDialog:!0},{id:"Username",showInSearchDialog:!0}],mode:"edit",register:!0});t.render(),m.registerField({id:"skuid__Assigned_To_User__c",row:n,handleChange:function(){p=f=m.getFieldValue(n,"skuid__Assigned_To_User__c",!0),m.updateRow(n,l,p,{initiatorId:k}),i=m.getFieldValue(n,"skuid__Assigned_To_User__r.Name")}});var u=t.element;e.element.addClass("nx-polymorphic").append(q,s,u),"org"===h?(s.hide(),u.hide()):"profile"===h?u.hide():"user"===h&&s.hide()}else{var v=b("<div>").addClass("nx-fieldtext").html(i);e.element.removeClass("nx-polymorphic").html(v)}}),f("skuid.pageAssignments.pageLookup",function(a,c){var d=a.model.getFieldValue(a.row,"skuid__Use_Standard_Layouts__c");if((d||!c&&0!==c)&&(c=""),"edit"!==a.mode)a.element.removeClass("nx-polymorphic"),d?i("TEXT").read(a,"(Use Standard Layouts)"):i("REFERENCE").read(a,c);else{var e,f,g=b("<select>");i("REFERENCE").edit(a,c),e=a.element.children("input").first(),f=a.element.children(".nx-field-reference-search").first(),g.append(b("<option>").prop("selected",!d).attr("value","skuid").text("Skuid Page"),b("<option>").prop("selected",d).attr("value","standard").text("Use Standard Layouts")).on("change",function(){a.model.updateRow(a.row,a.id,"",{initiatorId:a._GUID}),d="skuid"!==g.val(),a.model.updateRow(a.row,"skuid__Use_Standard_Layouts__c",d,{initiatorId:a._GUID}),d?(e.hide(),f.hide()):(e.show(),f.show())}),a.element.addClass("nx-polymorphic").prepend(g),d&&e.hide()}}),f("skuid.pageAssignments.recordTypeLookup",function(e,f){var g,h,i,j=c("RecordTypes"),k=a.label.merge(d("Any_X"),j.label||""),l=function(){var a=e.row.skuid__SObject_Type__c;g=[],h={},b.each(j.data,function(b,c){if(c.SobjectType===a){var d={label:c.Name,value:c.DeveloperName};g.push(d),h[c.DeveloperName]=d}})};if(l(),f&&h[f]?f=h[f].label:(f=k,i="any"),"edit"===e.mode&&j.accessible){var m=b("<select>");m.append(b("<option>").prop("selected","any"===i).attr("value","any").text(k)),m.append(b("<option>").prop("selected","any"!==i).attr("value","specific").text(d("Specific_Record_Type"))),m.on("change",function(){e.model.updateRow(e.row,e.id,"",{initiatorId:e._GUID}),"any"!==m.val()&&m.val()?"specific"===m.val()&&(n.show(),n.val("")):n.hide()});var n=b("<input>").val(f).autocomplete({source:function(a,c){l(),c(b.ui.autocomplete.filter(g,a.term))},select:function(a,b){return e.model.updateRow(e.row,e.id,b.item.value,{initiatorId:e._GUID}),n.val(b.item.label),!1},minLength:0}).blur(function(){""===n.val()&&e.model.updateRow(e.row,e.id,"",{initiatorId:e._GUID})});e.element.addClass("nx-polymorphic").append(m,n),"any"===i&&n.hide()}else{var o=b("<div>").addClass("nx-fieldtext").html(f);e.element.removeClass("nx-polymorphic").append(o)}});var j;f("skuid.pageAssignments.sObjectTypeLookup",function(a,c){var d="objectType";if(j||(j=e.getSnippet("skuid.snippets.utils.GetSObjectsAsItems")()),c||0===c?-1==b.inArray(c,g.sObjectList)&&(d="arbitrary"):c="","edit"!==a.mode){var f=b("<div>").addClass("nx-fieldtext").html(c);a.element.removeClass("nx-polymorphic").append(f)}else{var h,i,k,l=b("<select>");k=function(a){"arbitrary"===a?(h.hide(),i.show()):(h.show(),i.hide())},l.append(b("<option>").prop("selected","objectType"===d).attr("value","objectType").text("Object Type")),l.append(b("<option>").prop("selected","arbitrary"===d).attr("value","arbitrary").text("Other Situation")),l.on("change",function(){a.model.updateRow(a.row,a.id,"",{initiatorId:a._GUID}),h.val(""),i.val(""),k(l.val())}),h=b("<input>").val(g.decodeHTML(c)).autocomplete({source:j,select:function(b,c){return a.model.updateRow(a.row,a.id,c.item.value,{initiatorId:a._GUID}),h.val(c.item.label),!1},minLength:0}).blur(function(){""===h.val()&&a.model.updateRow(a.row,a.id,"",{initiatorId:a._GUID})}),i=b("<input>").val(g.decodeHTML(c)),g.delayInputCallback(i,function(b){a.model.updateRow(a.row,a.id,b,{initiatorId:a._GUID})}),a.element.addClass("nx-polymorphic").append(l,h,i),k(d)}}),f("skuid.pageAssignments.objectTypesMultipicklist",function(d){var e=c("assign__UniqueObjectTypesUsed_Packaging").data;d.element.append(a.ui.renderers.MULTIPICKLIST.edit({entries:b.map(e,function(a){return{value:a.objectType,label:a.objectType}}),renderas:e.length<=10?"CHECKBOXES":"",selectedList:8,onChange:function(a){d.model.updateRow(d.row,d.id,a,{initiatorId:d._GUID})}}))}),f("skuid.pageAssignments.createDefaultRowsForPackaging",function(){c("assign__StaticResourceInfoForPackaging").createRow(),c("assign__PageAssignmentInfoForPackaging").createRow()}),f("ExportAllPageAssignments",function(){function c(){f.exportData({useAPINamesForHeaders:!0}),g.text(a.label.merge(d("all_records_exported_to_csv"),f.data.length)),setTimeout(function(){b.unblockUI()},1500)}function e(){f.canRetrieveMoreRows?f.loadAllRemainingRecords({stepCallback:function(b,c){g.text(a.label.merge(d("retrieving_records_a_to_b"),b,c))},finishCallback:function(){c()}}):c()}var f=a.model.initializeModel(new a.model.Model({fields:[{id:"skuid__Environment_Type__c"},{id:"skuid__SObject_Type__c"},{id:"skuid__Action_Type__c"},{id:"skuid__Context__c"},{id:"skuid__RecordTypeDeveloperName__c"},{id:"skuid__Page__c"},{id:"skuid__Page__r.Name"},{id:"skuid__Page__r.skuid__Module__c"},{id:"skuid__Page__r.skuid__UniqueId__c"},{id:"skuid__Use_Standard_Layouts__c"},{id:"skuid__IsActive__c"},{id:"OwnerId"}],data:[],id:"AllPageAssignmentsForExport",objectName:"skuid__Page_Assignment__c",orderByClause:"skuid__Environment_Type__c, skuid__SObject_Type__c, skuid__Action_Type__c",doQuery:!0,doClone:!1,recordsLimit:200,canRetrieveMoreRows:!0})),g=b("<div>").text(d("retrieving_data_for_export"));b.blockUI({message:g}),f.load(function(){e()})});var k=a.sfdc,l=k.api,m=l.SObject,n=l.query,o=l.escapeMetadataBody;f("existingPageAssignmentPackRenderer",function(a,d){var e=c("assign__StaticResourceInfoForPackaging"),f=e.getFirstRow(),g=b("<input>").attr({type:"radio",name:"existingPageAssignmentPack"}).addClass("nx-radio").val(d).on("change.skuid",function(){var b=a.model,c=a.row;e.updateRow(f,{Name:b.getFieldValue(c,"Name"),Description:b.getFieldValue(c,"Description")})});a.element.append(g)}),f("skuid.pageAssignments.pack",function(){var a,d,e,f=arguments[0],g=f.model,h=f.packAll,i=c("assign__PageAssignmentInfoForPackaging"),j=i.getFirstRow(),k=c("assign__StaticResourceInfoForPackaging"),l=k.getFirstRow(),p=c("assign__PageAssignmentsInStaticResources"),q=k&&k.getFieldValue(l,"Name"),r=k&&k.getFieldValue(l,"Description"),s="SELECT Id, Name, Description FROM StaticResource WHERE Name = '"+q+"'",t="SELECT Id,Name,skuid__Environment_Type__c,skuid__SObject_Type__c,skuid__Action_Type__c,skuid__Context__c,skuid__Assigned_To_User__c, skuid__Assigned_To_User__r.Name, skuid__RecordTypeDeveloperName__c,skuid__Page__c,skuid__Page__r.skuid__UniqueId__c, skuid__Page__r.Name,skuid__Page__r.skuid__Module__c,skuid__Use_Standard_Layouts__c, skuid__IsActive__c FROM skuid__Page_Assignment__c ";if(h){if(i&&j){var u=[],v=i.getFieldValue(j,"EnvironmentTypesPackaging",!0);if(v?u.push("skuid__Environment_Type__c IN ('"+v.split(";").join("','")+"')"):u.push("skuid__Environment_Type__c = null"),"specific"===j.ObjectTypesPackaging){var w=i.getFieldValue(j,"skuid__SObject_Type__c",!0);w&&u.push("skuid__SObject_Type__c IN ('"+w.split(";").join("','")+"')")}var x=j.ProfilesPackaging;"org"===x?u.push("skuid__Context__c = null"):"organdprofile"===x&&u.push("(skuid__Context__c = null) OR (skuid__Context__c like '00e%')"),u.length&&(t+="WHERE ("+u.join(") AND (")+")")}}else{if(a="assign__Assignments_Classic"===g.id?"PageAssignmentsTable":"assign__Assignments_Lightning"===g.id?"PageAssignmentsTable_Lightning":null,a&&(d=b("#"+a),d.data("object")&&d.data("object").list&&(e=b("#"+a).data("object").list.getSelectedItems())),!e||!e.length)return void b.blockUI({message:"Please select at least one Page Assignment to package.",timeout:2500});t+="WHERE Id IN ('"+b.map(e,function(a){return a.row.Id}).join("','")+"')"}t+=" ORDER BY skuid__RecordTypeDeveloperName__c NULLS LAST, skuid__Context__c NULLS LAST, skuid__Use_Standard_Layouts__c DESC, skuid__Page__r.skuid__Module__c NULLS FIRST",b.blockUI({message:"Getting Page Assignment and StaticResource records..."});var y,z,A=n(s),B=n(t);b.when(B).then(function(a){z=a.records}),b.when(A).then(function(a){y=a.records}),b.when(A,B).then(function(){var a,c=b.Deferred();y.length>0?(a=new m("StaticResource",{Id:y[0].Id,CacheControl:"Private"}),c.resolve()):(b.blockUI({message:"Creating StaticResource..."}),a=new m("StaticResource",{Name:q,Description:r,Body:o(JSON.stringify([])),CacheControl:"Private"}),a.insert({success:function(){c.resolve()},error:function(a){c.reject({resourceName:q,errorMessage:a.responseJSON[0].message})}})),b.when(c).then(function(){b.blockUI({message:"Packaging Page Assignments into StaticResource..."}),a.Body=o(JSON.stringify(z)),a.ContentType="application/json",b.when(a.update()).then(function(){b.blockUI({message:'The "'+q+'" Page Assignments Pack was created/updated successfully!',timeout:3e3}),b(".ui-dialog-content").last().dialog("close"),i.cancel(),p.updateData()},function(a){b.blockUI({message:'There was an error creating the "'+q+'" Page Assignments Pack'+(a&&a.errorMessage?":\n\n"+a.errorMessage:"."),timeout:5e3})})},function(a){b.blockUI({message:'There was an error creating the "'+a.resourceName+'" Page Assignments Pack:\n\n'+a.errorMessage,timeout:5e3})})})}),f("skuid.pageAssignments.packAll",function(){var c=b.extend(arguments[0],{packAll:!0});a.snippet.getSnippet("skuid.pageAssignments.pack")(c)});var p;f("skuid.pageAssignments.unpack",function(){var c,d=[],e=b("#pageAssignmentSRSelect").find("input");return b.each(e,function(){var a=b(this),c=a.val();null!==c&&!0===a.prop("checked")&&d.push(c)}),d.length?(c=b.Deferred(),a.PageAssignment.RefreshFromPacks(JSON.stringify(d),function(a){var d=b.parseJSON(a);d&&(d.isSuccess?c.resolve():(d.errors&&d.errors.length&&(b.blockUI({message:d.errors[0],timeout:5e3}),c.reject()),p=d.recordFailures,c.reject()))},{escape:!1}),c.promise()):(b.blockUI({message:"Please select one or more Page Assignment Packs.",timeout:2500}),!1)}),f("skuid.pageAssignments.displayUnpackFailures",function(){if(!(p&&p.length>0))return!1;var a=c("assign__FailedAssignments"),d=[];b.each(p,function(){var a=this.record;b.extend(a,{Error:this.message}),d.push(a)}),a.adoptRows(d)}),f("skuid.pageAssignments.bytesToKBs",function(){var a=arguments[0],c=arguments[1],d=0;b.isNumeric(c)&&(d=b.number(c/1e3,1)+" KB"),i("TEXT").read(a,d)})}(skuid);