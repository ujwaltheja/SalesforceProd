!function(e){var t={};function a(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,a),r.l=!0,r.exports}a.m=e,a.c=t,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},a.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=1771)}({1771:function(e,t,a){"use strict";!function(e){var t=e.$,a=t.each,n=t.extend,r=e.dataSource,i=r.libraries.skuid,o=".",s=r.core||(r.core={}),d=e.utils,c=d.isString,u=d.createMapForArray,l=d.makeXMLDoc,p=e.time,f=p.parseSFDateTime,m=p.parseDateTimeString,y=p.getSFDateTime,h=t.Deferred,g=e.constants.HTTP_VERBS,v=g.PATCH,b=g.MERGE,F=g.POST,E=g.DELETE,S={"Edm.String":"STRING","Edm.Boolean":"BOOLEAN","Edm.Date":"DATE","Edm.DateTime":"DATETIME","Edm.DateTimeOffset":"DATETIME","Edm.Int16":"NUMBER","Edm.Int32":"NUMBER","Edm.Decimal":"NUMBER","Edm.Double":"NUMBER","Edm.Int64":"NUMBER","Edm.Guid":"STRING"},M="skuidSupportsBatch",T=["@odata.editLink","@odata.id","@odata.type"],R=["__metadata"],C=function(e){if(!e)return e;var t=" and".length,a=e.length-t,n=e.lastIndexOf(" and");return-1===n?e:n!==a?e:e.substring(0,a)},j=function(e,t,n){var r=n.major<4?R:T;a(r,function(a,n){t[n]&&(e[n]=t[n])})},D=function(e){var t=h(),a=x.prototype.getServiceVersion(e),n=a.major<4,r="odata"+(n?"3":"4"),o=n?"data.js":"odatav4.js";return e._odatalib?t.resolve():i[r]?(e._odatalib=i[r],t.resolve()):d.loadJS(function(e){return d.getStaticResourceUrl("lib/"+e,"skuid",void 0,d.getCacheTimestamp())}(o)).then(function(){e._odatalib=i[r]=function(e){var t;return e.major<4?{read:(t=window.OData).read,request:t.request,batchHandler:t.batchHandler,metadataHandler:t.metadataHandler,defaultHttpClient:t.defaultHttpClient}:{read:(t=window.odatajs.oData).read,request:t.request,batchHandler:t.batch.batchHandler,metadataHandler:t.metadata.metadataHandler,defaultHttpClient:t.net.defaultHttpClient}}(a),t.resolve()}),t.promise()},P=function(e,a){var n={};return n[e]=!0,t.extend(n,a)},O=["name"],x=function(e){a(O,function(t,a){if(!e[a])throw"Missing Required Property Error: "+a}),n(this,e),e.extendedProperties&&(n(!0,this.properties,e.extendedProperties),delete this.extendedProperties),r.DataSourceType.prototype.constructor.call(this,this),delete this.getModelProperties},N="metadata";x.prototype=new r.DataSourceType(!1),x.constructor=x,x.prototype=n(!0,x.prototype,{RESOURCE_TYPES:{RESOURCE_METADATA:N,RESOURCE_BATCH:"batch",RESOURCE_ENTITY_SET:"entitySet"},authenticateAndGetMetadata:function(e){var t=this;return e.dataSource.authenticate().then(function(){return t.getMetadata(e)})},populateSelect:function(e,t,a,n){var r,i;a.uiOnly||(r=a.id.split(o),a.isComplexField&&(r=[a.complexInReference?a.referenceParentId:r[0]]),i=r.join("/"),!1!==a.query&&(t&&!t[i]&&(e[i]=!0),n.keyField&&(e[i+"/"+n.keyField]=!0),(n.nameField||a.nameField)&&(e[i+"/"+(n.nameField||a.nameField)]=!0)))},getFieldDef:function(e,t,a,n){var r,i=n.metadata;return e.complexFields?e:(r=this.tryToGetComplexDef(e,e.id,t,a,n))?r:(r=this.getPropertyDef(e.id,t,i,a,t),e.id.split(o).length>1&&(e.editable=!1,e.createable=!1,e.sortable=!1),r)},isDefEditable:function(e,t,a){var n=!0;return a.major<4&&(n=!this.propertyHasExtension(e,"StoreGeneratedPattern")),t.isComplexField?n=!t.complexInReference&&a.major<4:!1===t.editable&&a.major>3&&(n=!1),n},isDefCreateable:function(e,t,a){return this.isDefEditable(e,t,a)||this.isDefRequired(e,t,a)},isDefRequired:function(e,t){return"false"===e.nullable&&!1!==t.editable},isDefFilterable:function(e){return"Edm.String"===e.type},buildFieldMetadata:function(e,a,n,r,i,o){var s,d,c,u,l=o.metadata,p=this.getServiceVersion(o);return!0===e.uiOnly?e:(s=this.getFieldDef(e,a,n,o))?(c={id:e.id,accessible:!0,createable:this.isDefCreateable(s,e,p),editable:this.isDefEditable(s,e,p),sortable:!0,label:e.id,displaytype:S[s.type]||s.type,edmtype:s.type,required:this.isDefRequired(s,e,p),filterable:this.isDefFilterable(s,e,p),minInputLength:1},e.defer&&(c.defer=!0),e.idField&&(c.idField=!0),this.isDefForComplexTypeField(s,l)&&this.populateFieldMetadataForComplexField(c,a),this.isDefForReferenceField(s)?this.populateFieldMetadataForReferenceField(c,s,n,i,l):this.isDefForComplexTypeField(s,l)?(d=!0,this.populateFieldMetadataForComplexField(c,a)):d||p.major>3&&(u=this.getEnumTypeFromDef(s,l))&&this.populateFieldMetadataForEnumField(c,u),this.coerceFieldMetadata(c,s),e.overrideMetadata&&t.extend(c,e),!1===e.query&&(c.query=!1),c):void 0},isDefForReferenceField:function(e){return!(!e.fromRole&&!e.isReferenceProp)},populateFieldMetadataForComplexField:function(e,t){var a=e.id,n=t.propertyMap[a].type;e.displaytype="OBJECT",e.rel=a,e.ref=n,e.referenceTo=[{objectName:n,label:n,relationshipName:a}]},populateFieldMetadataForEnumField:function(e,t){e.displaytype="PICKLIST",e.picklistEntries=t.picklistEntries,e.noneLabel=!e.required,e.deDupLabel=!0},populateFieldMetadataForReferenceField:function(e,a,n,r,i){var o,s,d,c,u,l=e.id,p=e.id.split(".").join("/");if(a.fromRole)o=this.getAssociation(a.relationship,i),s=this.getEndFromAssociation(o,a.toRole),e.rel=l,-1!==t.inArray(s.multiplicity,["0..1","1"])?(u=this.getEntityType(s.type,i),e.keyField=u.key.propertyRef[0].name,u.nameField&&(e.nameField=u.nameField),e.displaytype="REFERENCE",e.ref=s.type,e.referenceTo=[{objectName:s.type,label:s.type,relationshipName:l,keyField:e.keyField}]):(n&&(n[p]=!0),e.displaytype="ARRAY",e.type="array",e.dataPath="results",e.ref=s.type,e.referenceTo=[{objectName:s.type}],e.relationshipName=a.name,e.childSObject=s.type,d=this.getRefConstraintsFromAssociation(o,a.toRole),e.field=d.length&&d[0].name);else if(a.isReferenceProp){var f=a.type;e.rel=l,-1!==a.type.indexOf("Collection(")?(n&&(n[p]=!0),f=f.substring("Collection(".length,f.length-1),e.displaytype="ARRAY",e.type="array",e.ref=f,e.referenceTo=[{objectName:f}],e.relationshipName=a.name,e.childSObject=f,e.createable=!1,e.editable=!1):(c=a.referentialConstraint,(u=this.getEntityType(f,i))&&u.nameField&&(e.nameField=u.nameField),c&&c.length>0?e.keyField=c[0].referencedProperty:e.keyField=u.key[0].propertyRef[0].name,e.displaytype="REFERENCE",e.ref=a.type,e.referenceTo=[{objectName:a.type,label:a.type,relationshipName:l,keyField:e.keyField}],e.createable=!0,e.editable=!0),e.sortable=!1}},buildEntityMetadataRequest:function(e){var t=e.targetEntity;return!t&&e.model&&e.model.attr&&(t=e.model.attr("sobject")),{objectName:t}},buildResourceUri:function(e,t,a){if(!e)throw"Unable to build Resource URI";a||(a={});var n,r=d.combineUrls,i=e.serviceUrl,o=a.entitySet,s=a.keyPredicate,c=a.count;switch(t){case N:return r(i,"$metadata");case"batch":return r(i,"$batch");case"entitySet":return n=r(i,o),s&&(n+="("+s+")"),c&&(n+="/$count"),n;default:return i}},getAssociation:function(e,t){var a=this.processFullyQualifiedName(e);return this.getSchema(t,a.nameSpace).associationMap[a.name]},getEndFromAssociation:function(e,t){return e.end.filter(function(e){return e.role===t})[0]},getExtraEntityMetadata:function(t){return e.storage.tables.dataSourceMetadata.add(t.name,{dataSource:t,entities:!1,data:t.metadata}),t.metadata},getEntityMetadata:function(e){var a=this,n=(e=e||{}).entities,r=e.dataSource;return a.authenticateAndGetMetadata(e).then(function(){return a.getExtraEntityMetadata(r,n)}).then(function(){var i=[],o={},s=r.metadata;return t.each(n,function(t,n){var r,d,u,l=function(e,t){var a,n,r,i=c(e)?e:e.objectName;return i?(n=(a=i&&i.split(".")).slice(0,-1).join("."),(r=t.dataServices.aliasMap)&&(n=r[n]||n),n+"."+a[a.length-1]):i}(n,s);if(!l)throw"No object name provided.";r=a.getEntitySet(l,s),d=a.getEntityTypeFromEntitySet(r,l,s),u=a.getFieldsFromEntityType(d,l,s,e.dataSource,e),a.cacheFieldsOfEntity({dataSource:e.dataSource,objectName:l},u,s,o),l.startsWith(".")&&(l=l.replace(".","")),i.push({childRelationships:[],fields:u,label:l,labelPlural:l,objectName:l,readonly:!1})}),i})},getEntityMetadataCacheKey:function(e){return c(e)?e:e.objectName},getEntityMetadataLoadingMessageFromBreadcrumb:function(e){return"Loading metadata for external object "+e.endsobject+"..."},getEntitySet:function(e,t){var a=this.processFullyQualifiedName(e),n=this.getSchema(t,a.nameSpace).entitySetMap;if(n&&n[a.name])return n[a.name]},getFlatEntitySetList:function(e){var a=this.getEntitySetList(e);return t.map(a,function(e){return d.isString(e)?e:e.value})},getEntitySetList:function(e){var a=[],n=this.getEntityContainerToList();return t.each(e.dataServices.schemaMap,function(e,r){var i;if(n&&r.entityContainerMap){var s=r.entityContainerMap[n];i=s&&s.entitySetMap}else i=r.entitySetMap;i&&t.each(i,function(t,n){var r=e+o+t;n.label?a.push({label:n.label,value:r}):a.push(e+o+t)})}),this.coerceEntitySetList(a),a},coerceEntitySetList:function(){},getDefaultNamespace:function(){},getIdField:function(e){var t=e.dataSource.metadata,a=this.getEntitySet(e.objectName,t),n=this.getEntityTypeFromEntitySet(a,e.objectName,t),r=this.getKeyFields(n,t);return Object.keys(r)[0]},getSchema:function(e,a){if(!a&&!(a=this.getDefaultNamespace()))return e.dataServices.schema[0];var n=e.dataServices.schemaMap;return n[a]||t.map(n,function(e){if(e.alias===a)return e})[0]},getEntityType:function(e,t){var a=this.processFullyQualifiedName(e),n=this.getSchema(t,a.nameSpace),r=n.entityTypeMap[a.name];return r?(this._buildEntitySpecificMaps(r,n,t),r):this._tryToGetComplexEntity(e,t)},getEntityTypeFromEntitySet:function(e,t,a){var n=e?e.entityType:t;return this.getEntityType(n,a)},getEntityTypeNameFromRefPropDef:function(e,t){var a;return e.relationship?(a=this.getAssociation(e.relationship,t),this.getEndFromAssociation(a,e.toRole).type):e.type?-1!==e.type.indexOf("Collection(")?e.type.substring("Collection(".length,e.type.length-1):e.type:void 0},getErrorFromErrorBody:function(e){var a,n,r;if((a=d.parseAsJSONIfString(e))&&t.isPlainObject(a)&&(a.error?a=a.error:a["odata.error"]&&(a=a["odata.error"]),a&&(n=a.code,r=t.isPlainObject(a.message)&&a.message.value?a.message.value:a.message)),!a)try{n=(a=d.makeXMLDoc(e)).find("code").text(),r=a.find("message").text()}catch(e){}return{code:n,message:r}},getFieldDataForItem:function(e,t,a){var n,r,i=a.split(o);return 1===i.length?"DATETIME"===t.displaytype?(n=e[a])?(r=n instanceof Date?n:m(n),y(r)):null:"Edm.Decimal"===t.edmtype||"Edm.Double"===t.edmtype?parseFloat(e[a]):"Edm.Int64"===t.edmtype?parseInt(e[a],10):e[a]:(n=e[i[0]],i.shift(),n?this.getFieldDataForItem(n,t,i.join(o)):null)},_getComplexTypeMap:function(e){return e.dataServices&&e.dataServices.complexTypeMap},_tryToGetComplexEntity:function(e,t){var a=this._getComplexTypeMap(t);if(a&&e)return a[e]},_setComplexTypeMap:function(e){var n={};return t.each(e.dataServices.schemaMap,function(e,a){var r=a.complexType;r&&t.each(r,function(t,r){n[e+o+r.name]={typeInfo:r,namespace:e},a.alias&&(n[a.alias+o+r.name]=n[e+o+r.name])})}),a(n,function(e,t){t.typeInfo.property=function e(t,a){if(!t)return[];a=a||{};var r=t.typeInfo,i=r.baseType,s=r.hasExpandedBaseType;return r.property||(r.property=[]),!i||s?r.property:(r.isDerived=!0,-1===i.indexOf(o)&&(i=t.namespace+o+i),r.hasExpandedBaseType=!0,a[i]?r.property:(a=P(i,a),r.property=r.property.concat(e(n[i],a)),r.property))}(t)}),d.size(n)||(n=null),e.dataServices.complexTypeMap=n,n},_setEnumTypeMap:function(e){var a={};return t.each(e.dataServices.schemaMap,function(e,n){var r=n.enumType,i=n.alias;r&&t.each(r,function(n,r){t.each(r.member,function(e,t){r.member[e].label=t.name}),a[e+o+r.name]=a[i+o+r.name]={picklistEntries:r.member,namespace:e,name:r.name}})}),e.dataServices.enumTypeMap=a,a},isDefForComplexTypeField:function(e,t){var a=e.type;return this._tryToGetComplexEntity(a,t)},getEnumTypeFromDef:function(e,t){var a=e.type,n=t.dataServices.enumTypeMap;if(n)return n[a]},_setMapOfPropertiesOfEntityType:function(e,a,n){if(e.propertyMap)return e.propertyMap;n||(n={});var r=this,i={},o=r.getPropertiesOfEntity(e);return o?(t.each(o,function(e,t){var o;if(t&&(i[t.name]=t,(o=r._tryToGetComplexEntity(t.type,a))&&!n[t.type])){n=P(t.type,n);var s=o;i[t.name].complexFields=r._setMapOfPropertiesOfEntityType(s,a,n)}}),e.propertyMap=i,i):{}},_setMapOfNavigationPropertiesOfEntityType:function(e,t){return e.navigationPropertyMap?e.navigationPropertyMap:e.navigationProperty&&e.navigationProperty.length?(a(e.navigationProperty,function(e,a){var n,r,i=a.type,o="",s=t.aliasMap,d=!!i&&0===i.indexOf("Collection("),c="";a.isReferenceProp=!0,i&&(d?o=i.substring("Collection(".length,i.length-1):i&&(o=i),(n=o.split(".")).length>1&&s&&s[r=n.slice(0,n.length-1)]&&(c=s[r]+"."+n[n.length-1],d&&(c="Collection("+c+")"),a.type=c))}),e.navigationPropertyMap=d.keyBy(e.navigationProperty,"name"),e.navigationPropertyMap):(e.navigationPropertyMap={},e.navigationPropertyMap)},tryToGetComplexDef:function(e,a,n,r,i,s){var c,u,l,p,f,m,y,h,g,v,b,F,E,S,M=i.metadata,T=this._getComplexTypeMap(M),R=this.getServiceVersion(i);if(T){if(this._buildEntitySpecificMaps(n,this.getSchema(M,n.__namespace),M),c=a.split(o),l=n.propertyMap,p=n.navigationPropertyMap,s=s||"",c.length>1&&(g=p[c[0]]),d.size(g))return S=c[0],v=this.getEntityTypeNameFromRefPropDef(g,M),b=this.getEntityType(v,M),F=a.substring(S.length+1),E=s?s+"/"+S:S,this.tryToGetComplexDef(e,F,b,r,i,E);if(c.length>1){if(m=c[c.length-2],c.length>2){var C=c.slice(0,c.length-1).join(".complexFields."),j=d.getObjectProperty(l,C);j&&(f=j.type)}2===c.length&&(f=l&&l[m]&&l[m].type),y=c[c.length-1],(h=!!f&&T[f])&&t.each(h.typeInfo.property,function(t,n){n.name===y&&(u=n,e.isComplexField=!0,e.complexParent=h,h.typeInfo.isDerived&&(e.editable=!1),r&&s&&(e.complexInReference=!0,R.major<=3&&(e.referenceParentId=s+"/"+a.substring(0,a.length-n.name.length-1),r[s]=!0)))})}return u}},coerceRequestedFields:function(e){return e},getPropertiesOfEntity:function(e){return e.property&&e.property.length?e.property:e.typeInfo&&e.typeInfo.property?e.typeInfo.property:[]},getFieldsFromEntityType:function(e,a,n,r,i){i=i||{};var o,s=this,d=s.processFullyQualifiedName(a).nameSpace,c=s.getPropertiesOfEntity(e),u=i.requestedFields,l=i.selects,p=i.expands,f=s.getSchema(n,d);return s._buildEntitySpecificMaps(e,f,n),u?(o={},t.each(u,function(e,t){o[t.id]=t}),t.each(s.getKeyFields(e,n),function(e,a){o[a.id]||u.push(t.extend(a,{idField:!0}))})):(u=[],c&&t.each(c,function(){var e={id:this.name};u.push(t.extend({},this,e))}),e.navigationProperty&&t.each(e.navigationProperty,function(){var e=!1;this.type&&0===this.type.indexOf("Collection(")&&(e=!0),u.push({id:this.name,isArray:e})})),u=s.coerceRequestedFields(u),t.map(u,function(t){var a=s.buildFieldMetadata(t,e,p,l,d,r);if(a)return l&&s.populateSelect(l,p,t,a),a})},supportsToLowerForFilters:function(){return!0},coerceFieldMetadata:function(){},getFilterStringFromCondition:function(e,t,n){n||(n={});var r,i,s,c,u,l,p=this,f=n.version||{major:1},m=n.fieldsMetadata||[],y=function(t){return p.getURLFormattedValue(t,r.edmtype,f,e)},h=f.major<4,g=e.field,v=function(e,t,a){return e=e.split(o).join("/"),a=d.isUndefined(a)?s:encodeURIComponent(a),e+" "+(t||"eq")+" "+a},b=function(e,t,a){e=e.split(o).join("/");return t+"("+(!0===a?s:e)+","+(!0===a?e:s)+")"},F=function(e,t,a){e=e.split(o).join("/");var n=s;return p.supportsToLowerForFilters()&&(e="tolower("+e+")",n=n.toLowerCase()),t+"("+(!0===a?n:e)+","+(!0===a?e:n)+")"},E=function(e){var t=[];return a(u,function(){this&&t.push("("+v(e,"eq",this)+")")}),"("+t.join(" or ")+")"},S={"=":function(e){return v(e,"eq")},"!=":function(e){return v(e,"ne")},gt:function(e){return v(e,"gt")},lt:function(e){return v(e,"lt")},gte:function(e){return v(e,"ge")},lte:function(e){return v(e,"le")},contains:h?function(e){return F(e,"substringof",!0)}:function(e){return F(e,"contains")},"does not contain":h?function(e){return F(e,"not substringof",!0)}:function(e){return F(e,"not contains")},"starts with":function(e){return b(e,"startswith")},"does not start with":function(e){return b(e,"not startswith")},"ends with":function(e){return b(e,"endswith")},"does not end with":function(e){return b(e,"not endswith")},in:function(e){return E(e)},"not in":function(e){return"not "+E(e)},">":function(e){return S.gt(e)},">=":function(e){return S.gte(e)},"<":function(e){return S.lt(e)},"<=":function(e){return S.lte(e)}};return e.inactive?"":"group"===e.type?p.getFilterStringFromConditions(e.subConditions,e.subConditionLogic,t,n):(r=p.getFieldMetadataFromConditionField(g,m,t))?(r.ref&&r.keyField&&(g=e.field+"."+r.keyField,r=p.getFieldMetadataFromConditionField(g,m,t)),i=p.coerceConditionValue(e.value,r),s=i&&y(i),c=e.values,u=c&&c.map&&c.map(y),(l=S[e.operator])?l(g):""):""},coerceConditionValue:function(e){return e},getFieldMetadataFromConditionField:function(e,t,n){var r,i={},o=e.split("."),s=n.dataSource,d=s&&s.metadata;if(a(t,function(e,t){i[t.id]=t}),i[e])return i[e];if((r=i[o[0]])&&r.ref&&!(o.length<2)){var c=r.ref,u=this.getEntityType(c,d),l=this.getFieldsFromEntityType(u,c,d,s);return o.shift(),this.getFieldMetadataFromConditionField(o.join("."),l,n)}},getFilterStringFromConditions:function(e,a,n,r){var i=this,o="",s=t.map(e,function(e){return i.getFilterStringFromCondition(e,n,r)||"!!"});return s.length&&(a||(a=t.map(e,function(e,t){if(!0!==e.inactive)return t+1+""}).join(" and ")),a&&(-1!==(o=(o=d.makeConditionLogicString(a,s,{customAndString:" and ",customOrString:" or "})).replace(/\(\)/g,"")).indexOf("!!")&&(o=o.replace(/(((AND)|(OR)) ?!!)|(!! ?((AND)|(OR)))|!!|\(!!\)/gi,"").trim()),o=C(o))),o},getItemForDML:function(a,n,r){var i,o,s=a.edmtype,u=d.adjustValueBasedOnQuotedness;return"Edm.Binary"===s?n=window.btoa(n):-1!==t.inArray(s,["Edm.Boolean","Edm.Byte","Edm.Double","Edm.Int16","Edm.Int32","Edm.SByte","Edm.Single"])?n=u(n,!1):-1!==t.inArray(s,["Edm.Decimal","Edm.Guid","Edm.Int64","Edm.String"])?r.major<4||"Edm.String"===s?n=!1===c(o=n)?""+o:o:"Edm.Int64"!==s&&"Edm.Decimal"!==s||(n=u(n,!1)):"Edm.DateTime"===s?(i=f(n),n=e.time.formatDate("yy-mm-ddT",i)+e.time.formatTime("HH:mm:ss.SSS",i)):"Edm.DateTimeOffset"===s&&(i=f(n),n=(n=e.time.formatDate("yy-mm-ddT",i)+e.time.formatTime("HH:mm:ss.SSS000Z",i)).slice(0,-2)+":"+n.slice(-2)),n},getODataLibrary:function(e){return e._odatalib},getURLFormattedValue:function(a,n,r){var i=e.time,o=r.major<4,s=function(e,t,a){return a&&r.major>a?t:e+"'"+t+"'"},c=function(e,t,a){return a&&r.major>a?t:t+e},u=function(e){if(d.isNumber(e))return parseFloat(e);throw'The value "'+e+'" could not be translated to a number.'},l=function(e){var a;if(d.isDate(e)?a=e:d.isNumber(e)?a=new Date(e):d.isString(e)&&((a=i.parseDateTimeString(e))||(a=i.resolveDateKeyword(e)),t.isArray(a)&&(a=a[0])),!a)throw'The value "'+e+'" could not be translated to a date.';return a};return null===a?"null":"Edm.Boolean"===n?a?"true":"false":"Edm.Byte"===n?u(a).toFixed(0):"Edm.DateTimeOffset"===n?s("datetimeoffset",l(a).toISOString(),3):"Edm.Decimal"===n?c("M",function(e){var t=d.userLocale.decimalsSeparator;if(-1===e.indexOf(t))return e;var a=new RegExp("\\"+t+"?0+$");return e.replace(a,"")}(u(a).toFixed(20)),3):"Edm.Double"===n?c("D",u(a).toString(),3):"Edm.Guid"===n?s("guid",a,3):"Edm.Int16"===n?u(a).toFixed(0):"Edm.Int32"===n?u(a).toFixed(0):"Edm.Int64"===n?c("L",u(a).toFixed(0),3):"Edm.Float"===n&&o||"Edm.Single"===n?c("F",u(a).toString(),3):"Edm.SByte"===n?u(a).toFixed(0):"Edm.DateTime"===n&&o?s("datetime",l(a).toISOString().slice(0,-1),3):"Edm.Date"!==n||o?"Edm.TimeOfDay"!==n||o?"'"+(""+a).replace("'","''")+"'":l(a).toISOString().split("T")[1].slice(0,-1):l(a).toISOString().split("T")[0]},getIndividualKeyFormatted:function(e,t,a,n){return this.getURLFormattedValue(a[e],t.edmtype,n)},getKey:function(e,a,n,r){var i,o=a.key,s=this;return t.isArray(o)&&(o=o[0]),o?o.propertyRef.length>1?t.map(o.propertyRef,function(t){return t.name+"="+s.getIndividualKeyFormatted(t.name,r[t.name],e,n)}).join(","):(i=o.propertyRef[0].name,d.isUndefined(e[i])?void 0:s.getIndividualKeyFormatted(i,r[i],e,n)):""+(e.Id||e.ID||e.id)},getKeyFields:function(e){var a={},n=e.key;return t.isArray(n)&&(n=n[0]),n&&n.propertyRef&&t.each(n.propertyRef,function(t,n){a[n.name]={id:n.name,entityType:e}}),a},getKeyFieldsInOrderedList:function(e){var a=[],n=e.key;return t.isArray(n)&&(n=n[0]),n&&n.propertyRef&&(a=t.map(n.propertyRef,function(t){return{id:t.name,entityType:e,edmtype:e.propertyMap[t.name].type}})),a},getMetadata:function(e){var t=this;return D(e.dataSource).then(function(){return t.queryMetadata(e)})},getModelProperties:function(t,a){var n=e.builder.core,r=t.state,i=n.getUnsavedChangesWarningProperty({component:t}),s=n.getCoreModelBasicProperties({component:t,propViewer:a}),c=[];return s.push({id:"sobject",type:"sobject",dataSourceTypeName:this.name,dataSourceName:r.attr("datasource")||r.attr("service"),label:"External Object Name",showLabelInTextInput:!0,onChange:function(e){if(e&&(!r.attr("label")||!r.attr("labelplural"))){var a=e.split(o).pop();r.attr("label")||r.attr("label",a),r.attr("labelplural")||r.attr("labelplural",a+(d.endsWith(a,"s")?"":"s")),t.save()}}}),Array.prototype.push.apply(s,n.getModelLabelProperties()),s.push(n.getModelQueryOnPageLoadProperty({component:t,propViewer:a}),n.getAsyncLoadProperty({component:t}),n.getModelLimitProperty(),n.getModelOrderByProperty(),n.getCreateDefaultRowProperty(),n.getModelNameFieldProperty()),i&&c.push(i),c.push(n.getDeferFieldRenderingProperty(!0)),c.push(n.getFieldsToDeferProperty(t)),[{name:"Basic",props:s},{name:"Advanced",props:c}]},getNameField:function(e,t){var a,n,r,i,o=t&&t.metadata;return o&&(a=this.getEntitySet(e,o),n=this.getEntityTypeFromEntitySet(a,e,o),i=Object.keys(this.getKeyFields(n)),n.nameField?r=n.nameField:i&&i.length>0&&(r=i[0])),r},getRowName:function(e,t,a){return t.getFieldValue(e,a.getNameField(t.objectName),!0)},getRowId:function(e,t,a){var n=t.fields.length&&t.fields.filter(function(e){return e.idField})[0];if(n)return e[n.id];var r=a.metadata,i=r&&this.getEntitySet(t.objectName,r),o=r&&this.getEntityTypeFromEntitySet(i,t.objectName,r),s=this.getServiceVersion(a);return this.getKey(e,o,s,t.fieldsMap)},getEntityContainerToList:function(){},getEntityList:function(e){var t=this,a=h();return t.authenticateAndGetMetadata(e).then(function(n){a.resolve(t.getEntitySetList(n,e))},function(e){if("string"==typeof e)a.reject(e);else{var t=e.response,n=t.error;a.reject(n,t)}}),a.promise()},getEntityLabel:function(e,t){var a=t.metadata&&this.getEntitySet(e,t.metadata);if(a)return a.label},getPropertyByName:function(e,t){var a,n;return e.propertyMap?((n=e.propertyMap[t])||(n=e.navigationPropertyMap&&e.navigationPropertyMap[t]),n&&(a=n)):a=this.getPropertiesOfEntity(e).concat(e.navigationProperty).filter(function(e){return!!e&&t===e.name})[0],a},getPropertyDef:function(e,t,a,n,r,i){var s=e.split(o),d=this.getPropertyByName(t,s[0]);if(1===s.length)return n&&r.navigationPropertyMap[s[0]]&&(n[s[0]]=!0),d;var c=this.getEntityTypeNameFromRefPropDef(d,a),u=this.getEntityType(c,a);return n&&r.navigationPropertyMap[s[0]]&&(n[(i&&i+"/"||"")+s.slice(0,s.length-1).join("/")]=!0),s.shift(),this.getPropertyDef(s.join(o),u,a,n,r,i)},getRefConstraintsFromAssociation:function(e,a){var n=[];return e.referentialConstraint&&t.each(e.referentialConstraint,function(e,r){r.role===a&&t.each(r.propertyRef,function(){n.push(this)})}),n},getRowForItem:function(e,a,n,r){var i=this,s={};return t.each(n,function(t,a){-1!==a.id.indexOf(o)?d.setObjectProperty(s,a.id,i.getFieldDataForItem(e,a,a.id)):s[a.id]=i.getFieldDataForItem(e,a,a.id)}),j(s,e,r),s},getServiceVersion:function(e){if(e.metadata&&e.metadata.skuidVersion)return e.metadata.skuidVersion;var t=((e&&e.getConfigProperty("odata-version")||"1.0")+"").split(o),a=parseFloat(t[0]),n=parseFloat(t[1]),r=parseFloat(t[2]),i={major:isNaN(a)?0:a,minor:isNaN(n)?0:n,patch:isNaN(r)?0:r};return i.stringRep=[i.major,i.minor].join(o),i},getSelectClause:function(e){var t=Object.keys(e);if(t.length)return"$select="+t.join(",")},getExpandClause:function(e){var t=Object.keys(e);if(t.length)return"$expand="+t.join(",")},getOrderByClause:function(e){if(e.orderByClause)return"$orderby="+e.orderByClause.replace(/nulls first/gi,"").replace(/nulls last/gi,"").replace(/asc/gi,"asc").replace(/desc/gi,"desc")},getFilterClause:function(e,t,a,n){var r=this.getFilterStringFromConditions(e,t.conditionLogic,t,{version:a,fieldsMetadata:n});if(r)return"$filter="+r},getSkipClause:function(e){var t=e.offsetPageNumber,a=e.offsetPageSize;if(t>1&&a>0)return"$skip="+(t-1)*a},getTopClause:function(e){var t=e.offsetPageSize||e.recordsLimit;if(0===t||t>0)return"$top="+(parseInt(t,10)+1)},createQualifiedURL:function(e,n,r,i,o,s){var c,u,l=[],p=e.getDataSource(),f=d.combineUrls(p.serviceUrl,s.name);if(p)return u=(c=this.getServiceVersion(p)).major>3?function(e,n){a(e,function(e){delete n[e]});var r={};a(e,function(e){var t=r[e]=[];a(n,function(a){0===a.indexOf(e+"/")&&-1===a.substring((e+"/").length).indexOf("/")&&(delete n[a],t.push(a.substring((e+"/").length)))})}),function e(t){var n=r;a(n,function(a,r){if(t){if(0===a.indexOf(t.name+"/")){var i={name:a.substring((t.name+"/").length),list:r};t.list.push(i),delete n[a],e(i)}}else e({name:a,list:r})})}();var i={str:"$expand="};if(d.size(r)&&function e(n,r){var i=!0;a(r,function(r,o){var s=!1,d=!1;if(i||(n.str+=","),i=!1,n.str+=r,o.length){var c=[];a(o,function(e,a){t.isPlainObject(a)||c.push(a)}),c.length&&(n.str+="($select=",n.str+=c.join(","),s=!0),a(o,function(a,r){if(t.isPlainObject(r)){s||d?!d&&s&&(n.str+=";$expand=",d=!0):(n.str+="($expand=",d=!0);var i={};i[r.name]=r.list,e(n,i)}}),!d&&!s||i||(n.str+=")")}})}(i,r),d.size(e))return i.str}(i,o):this.getExpandClause(i),l.push(u),l.push(this.getSelectClause(o)),l.push(this.getOrderByClause(e)),l.push(this.getFilterClause(n,e,c,r)),l.push(this.getSkipClause(e)),l.push(this.getTopClause(e)),(l=l.filter(function(e){return void 0!==e})).length&&(f+="?"+encodeURI(l.join("&"))),f},cacheEntityFieldMetadataForModel:function(e){var a=this,n=e.getDataSource(),r=n.metadata,i=function(e,a){var n=e.objectName,r=e.fields,i=e.getDataSource(),o=i.metadata,s=a.getEntitySet(n,o);n=s&&s.entityType||n;var c={};c[n]=!0,t.each(r,function(e,t){t.ref&&(c[t.ref]=!0)});var u=r.filter(function(e){return-1!==e.id.indexOf(".")});return t.each(u,function(e,r){var s=r.id.split("."),u=n;t.each(s,function(e,t){var n=a.getEntityType(u,o);if(!n)return!1;var r=a.getFieldsFromEntityType(n,u,o,i);if(!r||!r.length)return!1;var s=(r=d.keyBy(r,"id"))[t];return!!s&&!!s.ref&&(c[s.ref]=!0,void(u=s.ref))})}),c}(e,a);t.each(i,function(e){if(!n.getCachedEntityMetadata(e)){var t=a.getEntityType(e,r),i=a.getFieldsFromEntityType(t,e,r,n);n.cacheEntityMetadata(e,{objectName:e,label:e,labelPlural:e,fields:i})}})},cacheFieldsOfEntity:function(e,t,a,n,r){var i=e.objectName,o=e.label||i,s=e.labelPlural||i,d=e.dataSource,c=this.getEntitySet(i,a);if(i=c&&c.entityType||i,r=r||0,n=n||{},!(d.getCachedEntityMetadata(i)||(n[i]={objectName:i,label:o,labelPlural:s,fields:t},d.cacheEntityMetadata(i,{objectName:i,label:o,labelPlural:s,fields:t}),r>5)))for(var u=0;u<t.length;u++){var l=t[u];if(l.ref&&!n[l.ref]){i=l.ref;var p=this.getEntityType(i,a),f=this.getFieldsFromEntityType(p,i,a,d);this.cacheFieldsOfEntity({dataSource:d,objectName:i},f,a,n,r+1)}}},getConditionsOfODataModel:function(e){return t.map(e.conditions,function(t){var a=e.getConditionValueResult(t);return t.originalValue||(t.originalValue=a.value),t})},coerceModelMetadata:function(e,t){"true"===t.abstract&&(e.createable=!1,e.updateable=!1,e.deleteable=!1)},loadIndividualModel:function(e,a,n){var r,i,o,s,c,u,l,p,f=a.metadata,m=h(),y=e.objectName,g=e.label||y,v=e.labelPlural||y,b=e.orderByClause,F={},E={},S=e.offsetPageSize||e.recordsLimit;if(!y)return m.reject("No object name specified for Model: "+e.id).promise();t.each(e.fields,function(a,n){t.isArray(e.deferredFields)&&t.inArray(n.id,e.deferredFields)>-1&&(n.defer=!0,e.fieldsMap[n.id].defer=!0)}),i=this.getEntitySet(y,f),o=this.getEntityTypeFromEntitySet(i,y,f),u=this.getConditionsOfODataModel(e),s=this.getFieldsFromEntityType(o,y,f,e.dataSource,{requestedFields:e.fields,selects:F,expands:E}),c=this.getFieldsFromEntityType(o,y,f,e.dataSource),this.cacheEntityFieldMetadataForModel(e),e.deferFieldRendering&&t.each(s,function(e,t){t.defer&&delete F[t.id]});try{r=this.createQualifiedURL(e,u,c,E,F,i)}catch(e){if(d.isString(e)&&-1!==e.indexOf("could not be translated"))return d.reject(e);throw e}return p={label:g,labelPlural:v,accessible:!0,createable:!0,updateable:!0,deleteable:!0,fields:s,soql:r,conditions:u,recordsLimit:S,objectName:y,orderByClause:b},this.coerceModelMetadata(p,o),!1===e.doQuery?m.resolve(p):(l={requestUri:r,model:e},n&&t.extend(!0,l,n),this.fetchData(a,l,o,s,S).then(function(e){return t.extend(p,e),p}))},makeODataRequest:function(e,t){var a=h();return this.getODataLibrary(e).read(t,function(e){a.resolve(e)},function(e){a.reject(e)},void 0,e.httpClientOfDataSourceType,e.metadata),a.promise()},coerceRequest:function(){},fetchData:function(e,a,n,r,i){var o=this,s=o.getServiceVersion(e);return o.makeODataRequest(e,a).then(function(e){var c,u=!1,l=s.major<4?e.results:e.value;return c=l&&t.isArray(l)?t.map(l,function(e){return o.getRowForItem(e,n,r.filter(function(e){return!1!==e.query}),s,d.keyBy(r,"id"))}):!l&&a.singleRow?e:[],i&&c.length>i&&(u=!0,c.pop()),{data:c,canRetrieveMoreRows:u}})},makeAdditionalQueries:function(a,n){var r,i=a.dataSource,o=i.metadata,s=this.getServiceVersion(i),d=a.objectName,c=this.getEntitySet(d,o),u=this.getEntityTypeFromEntitySet(c,d,o),l=this.getFieldsFromEntityType(u,d,o,i,{requestedFields:a.fields,selects:(r={},t.each(a.deferredFields,function(e,t){r[t]=!0}),r)}),p={requestUri:s.major<4?n.__metadata.uri:n["@odata.id"],singleRow:!0};return this.coerceAdditionalQueries(p),this.fetchData(i,p,u,l).then(function(t){return a.fields.map(function(e){e.defer&&t.data[e.id]&&(n[e.id]=t.data[e.id])}),e.events.publish("odata.deferred.loaded",[n]),{row:n,model:a}})},coerceAdditionalQueries:function(){},getEntitySetFromEntityTypeName:function(e,t){var a=this,n=a.processFullyQualifiedName(e),r=a.getFlatEntitySetList(t).filter(function(r){var i=a.getEntitySet(r,t);return i.entityType===e||i.entityType===n.name})[0];return a.getEntitySet(r,t)},load:function(e,n){var r=this,i=h(),o=n.dataSource,s=[];return r.authenticateAndGetMetadata(n,e).then(function(){return r.getExtraEntityMetadata(o,e)}).then(function(){a(e,function(e,t){var a=t.objectName;if(a){var n=r.getEntitySet(a,o.metadata);n||(n=r.getEntitySetFromEntityTypeName(a,o.metadata),t.objectName=n.name)}}),t.each(e,function(){var e=r.loadIndividualModel(this,o,n);s.push(e)}),t.when.all(s).then(function(e){i.resolve(e)},function(e){var t=r.produceErrorTextFromErrors(e);i.reject(t)})},function(e,t){i.reject(e,t)}),i.promise()},produceErrorTextFromErrors:function(e){var a=this,n="There was a problem with an OData Query: ";return t.each(e,function(e,t){var r=a.getErrorFromErrorBody(t.message?t:t.response&&t.response.body);r&&t.response?n+=(r.code?r.code+" - ":"")+r.message+" - Request URL: "+t.response.requestUri:c(t)&&(n+=t)}),n},processFullyQualifiedName:function(e){var t=e.split(o);return{name:t.pop(),nameSpace:t.join(o)}},supportsBatch:function(e){var t="true"===(e.getConfigProperty("supports-batch")||"false");return h().resolve(t).promise()},search:function(a,n,r){var i=this,o=a.returning.map(function(e){var t=r[e.modelName];return e.fields||(e.fields=[]),t.searchFields=e.fields,t}),s=h();return i.getEntityMetadata({dataSource:a.dataSource,entities:o}).then(function(n){return t.each(n,function(e,n){var r=o[e],i=1;t.each(r.searchFields,function(r,s){t.each(n.fields,function(n,c){if((s=d.isString(s)?s:s.id)===c.id){if(c.filterable){var u=!1;t.each(o[e].conditions,function(t,n){n.name==="__global_search_"+i&&(u=!0,o[e].conditions[t].value=a.query)}),u||o[e].addCondition({name:"__global_search_"+i,sourceType:"param",sourceParam:"search",value:a.query,field:s,operator:"contains",encloseValueInQuotes:!0,inactive:!1}),i++}o[e].fields[r]=c}})}),r.conditionLogic?r.conditionLogic=r.conditionLogic.replace("AND","OR"):r.conditionLogic=r.conditions.map(function(e,t){if(!0!==e.inactive)return t+1+""}).join(" OR ")}),i.load(o,{dataSource:e.dataSource.getDataSource(a.dataSourceName),loadAllMetadata:!0,performingSearch:!0,ignoreCache:!0}).then(function(e){return s.resolve({request:a,results:e.map(function(e,t){var n=a.returning[t];return{label:e.label,labelPlural:e.labelPlural,objectName:r[n.modelName].objectName,objectMapKey:n.objectMapKey,modelName:n.modelName,records:e.data}})}).promise()})})},properties:{composer:{supports:{childRelationships:!1},canFieldsBeSelected:function(e){return!!e.breadcrumb.endsobject||"Select an external object for this Model."}},canAutoGenerateConditionsFromFields:!0,validConditionTypes:["fieldvalue","multiple","param","userinfo","blank","modelmerge"],canConditionsBeGrouped:!0,hasGlobalSearchEntities:!0},propertyHasExtension:function(e,t){return!!e.extensions&&e.extensions.filter(function(e){return e.name===t}).length>0},createPropertyExtensionsMap:function(e){var a={};if(e.extensions)return t.each(e.extensions,function(e,t){if(!t.name||void 0===t.value)return!0;a[t.name]=t.value}),a},_expandBaseTypeForEntity:function(e,t,a,n){if(!e||!t)return[];var r,i,s,d,c,u,l=e.baseType,p=a.dataServices,f=e.hasExpandedBaseType,m=e.__namespace;return n=n||{},!l||f?{properties:e.property||[],navigationProperties:e.navigationProperty||[],key:e.key}:(-1!==l.indexOf(o)&&(r=(i=l.split(o)).slice(0,i.length-1).join(o),s=l.substring(r.length+1)),r?(r=p.aliasMap[r]||r,e.baseType=r+o+s,d=(u=this.getSchema(a,r))&&u.entityTypeMap[s]):(d=this.getSchema(a,m).entityTypeMap[l],r=m),d?n[r+o+d.name]?{properties:e.property||[],navigationProperties:e.navigationProperty||[],key:e.key}:(n=P(r+o+d.name,n),e.hasExpandedBaseType=!0,c=this._expandBaseTypeForEntity(d,this.getSchema(a,r),a,n),e.property=(e.property||[]).concat(c.properties),e.navigationProperty=(e.navigationProperty||[]).concat(c.navigationProperties),e.key=c.key||e.key,{properties:e.property,navigationProperties:e.navigationProperty,key:e.key}):{properties:e.property||[],navigationProperties:e.navigationProperty||[],key:e.key})},_buildEntitySpecificMaps:function(e,t,a){var n,r=a.dataServices;e.builtMaps||(n=this._expandBaseTypeForEntity(e,t,a),e.property=n.properties,n.navigationProperties&&n.navigationProperties.length&&(e.navigationProperty=n.navigationProperties),e.key=n.key,this._setMapOfPropertiesOfEntityType(e,a),this._setMapOfNavigationPropertiesOfEntityType(e,r),e.builtMaps=!0)},_buildMetadataMaps:function(e,n){var r,i=n.major<4,o=e.dataServices;u([o],"schema","schemaMap","namespace",{addKeyRelationships:!1}),u(o.schema,"entityType","entityTypeMap","name",{addKeyRelationships:!1}),r=o.schema,o.aliasMap={},this._setComplexTypeMap(e),this._setEnumTypeMap(e),i&&(u(r,"association","associationMap","name",{addKeyRelationships:!1}),u(r,"entityContainer","entityContainerMap","name",{addKeyRelationships:!1})),a(r,function(e,a){var n,r,s,d;a.alias&&(o.aliasMap[a.alias]=a.namespace),i?r=a.entityContainer:(a.entityContainerMap={},r=(n=a.entityContainer)&&(a.entityContainerMap[n.name]=n)&&[n]),r&&(u(r,"entitySet","entitySetMap","name",{addKeyRelationships:!1}),s=a.entitySetMap={},t.each(r,function(){t.extend(s,this.entitySetMap)}),i&&(u(r,"associationSet","associationSetMap","name",{addKeyRelationships:!1}),d=a.associationSetMap={},t.each(r,function(){t.extend(d,this.associationSetMap)}))),t.each(a.entityTypeMap,function(e,t){t.__namespace=a.namespace})})},getBatchSupport:function(e){return d.getObjectProperty(e,"metadata.skuidSupportsBatch")},attachHttpClientToDataSource:function(a,n){var r=this,i=r.getODataLibrary(a),o=r.getServiceVersion(a).major<4;a.httpClientOfDataSourceType={request:function(s,c,u){var l,p,f=s.dataSource||a,m=t.extend(s.headers,n.headers),y=r.getServiceVersion(f),h=r.getBatchSupport(a);return o&&!h&&(m.DataServiceVersion=y.stringRep,m.MaxDataServiceVersion=y.stringRep),p={body:s.body,url:s.requestUri,method:s.method,headers:m},h||(p.contentType="application/json;odata=verbose"),r.coerceRequest(p,s),l=f.createHTTPRequest(p),f.useProxy?(f.authentication&&f.authentication.success&&(l.isAuthenticated=!0),e.ajax.proxy(l).done(function(e){var a,n=e?e.headers:null;if(3===y.major&&(t.each(["Content-Type","content-type"],function(e){if(n[e])return a=n[e],!1}),a&&"application/json"===a.slice(0,16))){var i=a.split(";"),o=!1;t.each(i,function(){if("odata"===this.slice(0,5))return o=!0,!1}),o||(e.headers["Content-Type"]=a+";odata=minimalmetadata")}var l={requestUri:s.requestUri,statusCode:e.statusCode,statusText:e.status,headers:e.headers,body:e.body instanceof Document?d.getXML(e.body):e.body};"2"===r.getStatusCode(e)?(r.coerceResponse(l,s.model),c(l)):u(e.status,l)}).fail(function(e){u({response:e})})):(t.extend(s,{requestUri:l.url,body:l.body,headers:l.headers}),i.defaultHttpClient.request(s,function(e){r.coerceResponse(e,s.model),c(e)},function(e){u(e)}))}}},coerceResponse:function(){},trimMetadataForCache:function(e){var t=e.dataServices,n=["aliasMap","complexTypeMap","enumTypeMap","schemaMap"];a(n,function(e,a){delete t[a]}),n=["entityContainerMap","entitySetMap","entityTypeMap","function","action"],a(t.schema,function(e,t){a(n,function(e,a){delete t[a]}),a(t.entityType,function(e,t){delete t.navigationPropertyMap,delete t.propertyMap,delete t.builtMaps}),d.isObject(t.entityContainer)?delete t.entityContainer.entitySetMap:a(t.entityContainer,function(e,t){delete t.entitySetMap})})},queryMetadata:function(e){var a=this,n=h(),r=e.dataSource,i=e.minimalOnly,o=a.getServiceVersion(r),s=a.getODataLibrary(r),d=function(e){var t=h();return a.populateExtraServersideCachedMetadata?a.populateExtraServersideCachedMetadata(e).then(function(e){t.resolve(e)}):t.resolve(),t.promise()};function c(e,t,i){var s,c,u=e&&e.dataServices;if(s=(i=i||{}).minimalOnly,c=i.fromSource,e&&(e.skuidVersion=o),u){a._buildMetadataMaps(e,o),r.metadata=e,(c?d(r,s):h().resolve().promise()).then(function(){return a.supportsBatch(r).then(function(t){return e[M]=t,s?(a.trimMetadataForCache(e),r.fetchingMetadata=!1,n.resolve(e)):n.resolve(e)},function(){e[M]=!1,r.fetchingMetadata=!1,n.resolve(e)})})}else{if(t)return"OK"===t.statusText?n.reject("Unable to parse metadata. Is your OData version correct?",t):n.reject(t.statusText+": "+t.body,t);n.reject("Attempted to pull from datasource cache, but failed")}}if(r.metadata)return n.resolve(r.metadata).promise();if(r.fetchingMetadata)return r._metadataFetch;function u(){return s.read({requestUri:a.buildResourceUri(r,N)},function(e,t){c(e,t,{minimalOnly:i,fromSource:!0})},function(e,t){n.reject(e,t)},s.metadataHandler,r.httpClientOfDataSourceType)}function l(e){e.setPersistentCacheProperties({url:null,version:null}),t.get("/api/v1/datasource-metadata?datasource="+e.name).then(function(a){e.setPersistentCacheProperties({url:a.signedRequest,version:e._metadataCacheVersion}),t.get(a.signedRequest).then(function(e){c(JSON.parse(e))},u)},u)}if(r.fetchingMetadata=!0,a.attachHttpClientToDataSource(r,e),!r._metadataCacheVersion||i)u();else{var p,f=r.getCacheProperties(["url","version"]);f.version===r._metadataCacheVersion?p=f.url:r.setPersistentCacheProperties({url:null,version:null}),p?t.get(p).then(function(e){c(JSON.parse(e))},function(){l(r)}):l(r)}return r._metadataFetch=n.promise(),r._metadataFetch},coerceSaveItemRequest:function(){},coerceChanges:function(){return!1},getUpdateMethod:function(e){return this.getBatchSupport(e)?this.getServiceVersion(e).major<4?b:v:this.getServiceVersion(e).major<3?b:v},itemNeedsIfMatchHeader:function(e){return!(!e.__metadata||!e.__metadata.etag)},getItemChanges:function(e,a,n,r){var i=this,o={},s=i.getServiceVersion(r),d=s.major<4;return t.each(a,function(t,a){var n=e.getField(t);if("REFERENCE"===n.displaytype){var c=i.getEntitySetFromEntityTypeName(n.ref,r.metadata);d?o[t]={__metadata:{uri:c.name+"("+a[n.keyField]+")"}}:o[t+"@odata.bind"]=c.name+"("+a[n.keyField]+")"}else o[t]=i.getItemForDML(n,a,s)}),o},save:function(a,n){var r=this,i=h(),s=n.dataSource,d=this.getServiceVersion(s),u=d.major<4,l="application/json;"+(u?"odata=verbose":"odata.metadata=full"),p=r.getUpdateMethod(s);function f(){return{Accept:l,"Content-Type":l}}return r.authenticateAndGetMetadata(n).then(function(n){var s=[];t.each(a.operations,function(i,c){var l=e.$M(c.id),m=l.getDataSource(),y=[],g=r.getEntitySet(c.type,n),v=r.getEntityTypeFromEntitySet(g,c.type,n),b={},S=0,M=h(),T={deleteResults:[],insertResults:[],updateResults:[],totalsuccess:!0};function R(e,t,a){return{operationType:e,dataSource:m,model:l,key:t,row:a,operation:c,entitySet:g,entityType:v,version:d}}s.push(M),r.coerceChanges(c,a,l),t.each(c.deletes,function(e,t){var a,n=f(),i=l.getRowById(e);r.itemNeedsIfMatchHeader(i)&&(n["If-Match"]="*"),u||(n["Content-ID"]=""+e),j(t,i,d),r.coerceSaveItemRequest(a={requestUri:g.name+"("+e+")",method:E,__oldid:e,headers:n},R("delete",e,t)),y.push(a)}),t.each(c.updates,function(e,t){var a,n=l.getRowById(e),i=r.getItemChanges(l,t,n,m),o=f();r.itemNeedsIfMatchHeader(n)&&(o["If-Match"]="*"),u||(o["Content-ID"]=""+e),j(i,n,d),r.coerceSaveItemRequest(a={requestUri:g.name+"("+e+")",method:p,data:i,__oldid:e,headers:o},R("update",e,t)),y.push(a)}),t.each(c.inserts,function(e,t){var a,n=l.getRowById(e),i=r.getItemChanges(l,t,n,m),s=f(),d=v.__namespace+o+v.name,c=b[e];c||(c=++S),u?i.__metadata={type:d}:i["@odata.type"]="#"+d,s["Content-ID"]=""+c,r.coerceSaveItemRequest(a={requestUri:g.name,method:F,data:i,__oldid:e,headers:s},R("insert",e,t)),y.push(a)});var C=t.when();r.preSaveHook&&(C=r.preSaveHook(T,m,y,c)),C.then(function(){var e=[];return t.each(y,function(t,a){a.data&&a.data.__shouldRemove&&e.push(t)}),t.each(e.reverse(),function(e,t){y.splice(t,1)}),y.length?n.skuidSupportsBatch?r.handleBatchRequest(T,m,y,c).then(function(e){M.resolve(e)}):r.handleConcurrentRequests(T,m,y,c).then(function(e){M.resolve(e)}):M.resolve(T)}).catch(function(e){M.reject(e)})}),t.when.all(s).then(function(e){var a={insertResults:[],updateResults:[],deleteResults:[],globalErrors:[],totalsuccess:!0};t.each(e,function(e,n){t.merge(a.insertResults,n.insertResults),t.merge(a.updateResults,n.updateResults),t.merge(a.deleteResults,n.deleteResults),!1===n.totalsuccess&&(a.totalsuccess=!1)}),i.resolve(a)},function(e){var a=[],n=[];t.each(e,function(e,t){c(t.message)&&a.push(t.message),t.response&&n.push(t.response)}),i.reject(a,n)})}),i.promise()},getStatusCode:function(e){return e.statusCode?(e.statusCode+"").substring(0,1):"4"},handleConcurrentRequests:function(e,r,i,o){var s=this,c=h(),u=[],l=r.metadata;return a(i,function(t,a){var c=h(),p=n({},a,{requestUri:d.combineUrls(r.serviceUrl,a.requestUri)});u.push(c),s.getODataLibrary(r).request(p,function(a,n){var r=s.getStatusCode(n);if("4"===r||"5"===r)return e.totalsuccess=!1,c.reject(n.statusCode+" - "+n.statusText+" - "+n.body,n);s.handleResponse(n,i[t],o,e),c.resolve()},function(a){s.handleResponse(a,i[t],o,e),c.reject(a)},void 0,r.httpClientOfDataSourceType,l)}),t.settle(u).always(function(){c.resolve(n({globalErrors:[]},e))}),c.promise()},handleBatchRequest:function(e,a,r,i){var o=this,s=h();return o.getODataLibrary(a).request({requestUri:o.buildResourceUri(a,"batch"),method:F,data:{__batchRequests:[{__changeRequests:r}]}},function(a,d){var c=o.getStatusCode(d);"4"===c||"5"===c?s.reject(d.statusCode+" - "+d.statusText+" - "+d.body,d):(t.each(d.data.__batchResponses,function(a,n){n.__changeResponses?t.each(n.__changeResponses,function(t,a){o.handleResponse(a,r[t],i,e,!0)}):o.handleResponse(n,r[a],i,e,!0)}),s.resolve(n({globalErrors:[]},e)))},function(e,t){s.reject({message:"There was an error connecting to the proxy.",response:t})},o.getODataLibrary(a).batchHandler,a.httpClientOfDataSourceType),s.promise()},getKeyFieldsFromEntityId:function(e,t,n){var r=this,i=n.metadata,o=r.getServiceVersion(n),s=e.match(/[^()]+(?=\))+/g),d=r.getKeyFieldsInOrderedList(t,i),c={};return s?(s=s.pop().split(","),a(s,function(e,t){var a=t.indexOf("=");if(-1!==a){var n=t.substring(0,a),r=t.substring(a+1);c[n]=r}else c[d[e].id]=t}),a(d,function(e,t){var a=t.id;c[a]=r.getItemForDML(t,c[a],o)}),c):{}},coerceResponseItemData:function(){},handleResponse:function(t,a,r,i,o){var s,d=e.$M(r.id),c=d.dataSource,u=c.metadata,l=this.getEntitySet(r.type,u),p=this.getEntityTypeFromEntitySet(l,r.type,u),f=this.getServiceVersion(c),m=[],y=f.major<4,h=this.getUpdateMethod(c),g=t.data,v=y?g:g&&g.d||g,b=v?this.getRowForItem(v,p,d.fields,f,d.fieldsMap):null,S=b&&this.getKey(b,p,f,d.fieldsMap),M=this.getStatusCode(t),T={},R="";if(!S&&f.major>3&&t.headers&&(s=t.headers["OData-EntityId"])){var C=this.getKeyFieldsFromEntityId(s,p,c);if(a.data){var j=n({},a.data,C);b=this.getRowForItem(j,p,d.fields,f,d.fieldsMap),S=this.getRowId(b,d,c)}}t instanceof Error&&(M="2"),"4"!==M&&"5"!==M||(t.stack?"Unexpected end of JSON input"===t.message?R+="Service sent back an invalid JSON payload":R+=t.message:(T=this.getErrorFromErrorBody(t.response&&t.response.body),R="There was a problem with an OData "+(o?"Batch ":"")+"Request: ",T&&(R+=(T.code?T.code+" - ":"")+T.message)),m.push({fields:T.fields||[],message:R,rowId:a.__oldid,severity:"ERROR",status:"OData Error"})),this.coerceResponseItemData(a,t,b,C),a.method===h?i.updateResults.push({errors:m,id:a.__oldid,messages:[],record:b&&JSON.stringify(b),source:r.id,success:!m.length}):a.method===F?i.insertResults.push({errors:m,id:S,messages:[],oldId:a.__oldid,record:b&&JSON.stringify(b),source:r.id,success:!m.length}):a.method===E&&i.deleteResults.push({errors:m,id:a.__oldid,messages:[],source:r.id,success:!m.length}),m.length&&(i.totalsuccess=!1)},handleDefaultReferenceFieldValue:function(e,t,a,n){var r={},i={};n.keyField&&(i[n.keyField]=t.value,r[n.id]=i),a.updateRow(e,r)},getReferenceFieldRelationshipName:function(e){return e},getReferenceHandler:function(){var a=this;return{getBaseReferenceProps:function(e){return[{id:"targetobjects",type:"sobject",label:"Entity Type",dataSourceName:r.getDataSourceFromXML(e.state).name}]},getOverrideBatchProperties:function(){return[{type:"helptext",html:"Specify fields that will be added as related data. Any fields that are used in search or display templates will need to be added here."}]},getOverrideBatchNoItemsFunction:function(){return function(){return t("<div>").text("(Loading key field only.)")}},coerceObjectName:function(e,t){var n=a.getEntitySetFromEntityTypeName(e,t.metadata);return n?n.name:e},getOverrideBatchFieldChildrenFunction:function(e){return function(){return[{id:"batchfield",indent:1,linkedComponent:e,addtooltip:"Add New Batch Load Field",labelFunction:function(e){return e.attr("field")||"[No Field Selected]"},defaultStateFunction:function(){return l("<batchfield/>")},propsFunction:function(t){return[{id:"field",type:"field",label:"Field",sobject:e.state.attr("targetobjects"),dataSourceName:e.state.attr("datasource"),onChange:function(){t.refresh().rebuildProps()}}]}}]}},getMetadataHandler:function(a,n,i,o,s){var d,c=a.children("batchfields").first().children("batchfield"),u=a.attr("keyfield")||"ID",l=a.attr("targetobjects"),p=a.attr("ogdisplaytype"),f=a.attr("rel")||o+"__r";if(n.keyField=u,n.originalDisplayType=p,l&&(d=l.split(","),n.isNamePointing=d.length>1,(s||p&&"REFERENCE"!==p)&&(n.relationshipName=n.rel=f),n.referenceTo=t.map(d,function(e){return{accessible:!0,objectName:e}}),n.ref=l),!s&&p&&"REFERENCE"!==p){var m=r.getDataSourceFromXML(a),y=new e.model.Model({dataSource:m});y.id="_ReferenceLabelModel_"+(new Date).getTime()+f,c&&c.length?y.fields=t.map(c,function(e){return{id:t(e).attr("field")}}):y.fields=[{id:u}],y.doQuery=!0,y.doClone=!1,y.objectName=l,y.initialize();var h=new e.model.Condition;h.name="__reference_batch",h.operator="in",h.field=u,h.encloseValueInQuotes=!1,y.addCondition(h),i.batchLabelModels||(i.batchLabelModels={}),i.batchLabelModels[o]=y}},getReferenceValue:function(e,t){return a.getReferenceValue(e,t)},getRowFromReferenceValue:function(e,t,a){var n=e.getRows([{field:a.keyField||"ID",value:t}]);return n&&n.length?n[0]:{}},processReferenceLookupModel:function(e,t,a){e.objectName=a}}},getReferenceValue:function(e,t){return e[t.keyField||"ID"]},onDataSourceChange:function(e){e.attr("deferfieldrendering",!0)}}),n(s,{ODataDataSourceTypeBase:x}),d.runningTests()&&(x.prototype=n(!0,x.prototype,{unitTestableMethods:{removeTrailingAndIfNecessary:C}}))}(skuid)}});